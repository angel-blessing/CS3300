<html>
	<title>
		INFO 3300 Project 2
	</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<link rel="stylesheet" href="css/style.css">
	<h1> March Madness </h1>
	<div id = "bracket">
		<h2> March Madness 2017 </h2>
		Day <input id = "daySlider" type = "range" min = "0" max = "6" value = "0">
		<svg id = "bracketCircle" height = "800px" width = "900px"></svg>
	</div>
	<script>
		// Global variables for easy access in console
		var rawPredictData;
		var rawScoreData;
		// Parser for the prediction data
	    function parsePredictLine(line){
			return {
				rd0: Number(line["rd1_win"]),
				rd1: Number(line["rd1_win"]),
				rd2: Number(line["rd2_win"]),
				rd3: Number(line["rd3_win"]),
				rd4: Number(line["rd4_win"]),
				rd5: Number(line["rd5_win"]),
				rd6: Number(line["rd6_win"]),
				teamID: Number(line["team_id"]),
				teamName: line["team_name"],
				teamRating: Number(line["team_rating"]),
				teamRegion: line["team_region"],
				teamSeed: Number(line["team_seed"]),
				placement: Number(line["position"])
			};
		}
		// Parser for the score data
		function parseScoreLine(line){
			return {
				rdScore1: line["Round 1"],
				rdScore2: line["Round 2"],
				rdScore3: line["Round 3"],
				rdScore4: line["Round 4"],
				rdScore5: line["Round 5"],
				rdScore6: line["Round 6"],
				rdWin0: Number(line["rd0_win"]),
				rdWin1: Number(line["rd1_win"]),
				rdWin2: Number(line["rd2_win"]),
				rdWin3: Number(line["rd3_win"]),
				rdWin4: Number(line["rd4_win"]),
				rdWin5: Number(line["rd5_win"]),
				rdWin6: Number(line["rd6_win"]),
				teamID: Number(line["team_id"]),
				teamName: line["team_name"],
				placement: Number(line["position"])
			};
		}
		// Nested datasets after parsing
		var reverseData;
		var reverseScoreData;
		var teamPredict;
		var teamResults;
		var winningTeams;
	    // Load data for forecast
		d3.csv("Data/filtered_fivethirtyeight_ncaa_forecasts.csv", parsePredictLine, function(data){
			rawPredictData = data;
			teamPredict = d3.nest().key(function (d) {
				return d.teamName;
			}).map(rawPredictData);
			for (var i = 0; i < 7; i++){
				var tempRoundData = d3.nest().key(function (d) {
					return d.teamName;
				}).map(rawPredictData);
				roundData.push(tempRoundData);
			}
			reverseData = d3.nest().key(function (d) {
				return d.placement;
			}).map(rawPredictData);
			createCircle(teamPredict);
		});
	    // Load data for score
		d3.csv("Data/results.csv", parseScoreLine, function(data){
			rawScoreData = data;
			teamResults = d3.nest().key(function (d) {
				return d.teamName;
			}).map(rawScoreData);
			reverseScoreData = d3.nest().key(function (d) {
				return d.placement;
			}).map(rawScoreData);
			winningTeams = getWinners();
		});
		// Creates a datastructure to hold the winning teams for each round
		function getWinners(){
			var tempWinners = [];
			for (var round = 0; round < 7; round++){
				var interval = Math.pow(2, round);
				var roundBins = getScales();
				var currScale = roundBins[round];
				var game = 1;
				var teamsPerRound = [];
				while (game <= 64){
					var interval = Math.pow(2, round);
					for (var i = 0; i < interval; i++){
						var rdID = "rdWin" + round; 
						var isWinner = reverseScoreData.get(game + i)[0][rdID];
						if (isWinner){
							var teamName = reverseScoreData.get(game + i)[0]["teamName"];
							var winningTeam = {position: currScale(game + i), name: teamName};
							if (Number(round) == 5 && teamName == "Gonzaga"){
								winningTeam = {position: 1, teamName: "Gonzago"};
							}
							teamsPerRound.push(winningTeam);
						}
					}
					game += interval;
				}
				tempWinners.push(teamsPerRound);
			}
			return tempWinners;
		}
		// Global variables
		var roundData = [];
		var lastVal;
		// Creates an array of objects containing each slice of the circle
		function createSlices(){
			var slices = [];
			for (var roundNum = 0; roundNum < 7; roundNum++){
				for (var gameNum = 1; gameNum <= 64/Math.pow(2, roundNum); gameNum++){
					var currSlice = {
						x: gameNum,
						y: roundNum
					}
					slices.push(currSlice);
				}
			}
			return slices;
		}
		// Custom arc function to create the static circle bracket
		function getArc(){
			var width = 840,
			    height = width,
			    radius = 250,
			    padding = 50,
			    gameScale = d3.scaleLinear().domain([1, 65]).range([0, 2 * Math.PI]),
			    roundScale = d3.scaleLinear().domain([0, 6]).range([radius, padding]),
			    duration = 1000;
			return d3.arc()
			    .startAngle(function(d) {
			    	var xDisplacement = 1 + ((d.x - 1) * Math.pow(2, d.y));
			    	//console.log("b" + xDisplacement);
			    	return Math.max(0, Math.min(2 * Math.PI, gameScale(xDisplacement)));
			    })
			    .endAngle(function(d) {
			    	var xDisplacement =  1 + ((d.x) * Math.pow(2, d.y));
			    	//console.log("e" + xDisplacement);
			    	return Math.max(0, Math.min(2 * Math.PI, gameScale(xDisplacement))); })
			 	.innerRadius(function(d) {
			 		return Math.max(0, roundScale(d.y)); })
			    .outerRadius(function(d) {
			    	return Math.max(0, roundScale(d.y + 1)); });
		}
		// Takes in a slice and creates a centroid for that slice
		function getCentroid(d){
			var width = 900,
			    height = width,
			    radius = 250,
			    padding = 50,
			    gameScale = d3.scaleLinear().domain([1, 65]).range([0, 2 * Math.PI]),
			    roundScale = d3.scaleLinear().domain([0, 6]).range([radius, padding]),
			    duration = 1000;
			var xDisplacement1 = 1 + ((d.x - 1) * Math.pow(2, d.y));
			var xDisplacement2 =  1 + ((d.x) * Math.pow(2, d.y));
			var arc = d3.arc();
			return arc.centroid({
				innerRadius: Math.max(0, roundScale(d.y)),
				outerRadius: Math.max(0, roundScale(d.y + 1)),
				startAngle: Math.max(0, Math.min(2 * Math.PI, gameScale(xDisplacement1))),
				endAngle: Math.max(0, Math.min(2 * Math.PI, gameScale(xDisplacement2)))
			});
		}
		// Creates the quantize scales for each round to the outer placement
		function getScales(){
			var roundScales = [];
			// Placeholder scale for round 0 to make things easier later
			var round0 = d3.scaleLinear().domain([1,65]).range([1,65]);
			roundScales.push(round0);
			for (var round = 1; round < 7; round++){
				var tempRange = []
				for (var rangeNum = 1; rangeNum <= 64/Math.pow(2, round); rangeNum++){
					tempRange.push(rangeNum);
				}
				var tempScale = d3.scaleQuantize().domain([1, 64]).range(tempRange);
				roundScales.push(tempScale);
			}
			return roundScales;
		}
		// Removes all changes made by last interaction
		function reset(bracketSvg, roundBins, lastID){
			bracketSvg.selectAll("#p" + lastID.x + lastID.y)
				.style("fill", function(d){
					return "white";
			});
			for (var i = 1; i < 6; i++){
				var currScale = roundBins[i];
				var currID = "#p" + currScale(lastID.x) + i;
				bracketSvg.selectAll(currID)
					.style("fill", function(d){
						return "white";
				});
			}
			bracketSvg.selectAll("#centerLabel").remove();
			bracketSvg.selectAll("#sliceLabel").remove();
		}
		var myScale;
		// On mouse move
		function mouseMove(d){
			//console.log(d);
			var roundBins = getScales();
			var hueScale = d3.scaleLinear().domain([1,64]).range([0, 360]);
			if (lastID != ""){
				reset(bracketSvg, roundBins, lastID);
			}
			var hueIndex = hueScale(d.x);
			if (d.y == currentDay){
				lastID = {x: d.x, y: d.y};
				// Highlights outer layer
				bracketSvg.selectAll("#p" + d.x + d.y)
							.style("fill", "#C8C8C8");
				var teamName = winningTeams[d.y][d.x -1].name;
				var tempTeam = teamPredict.get(teamName);
				// Goes through path and fills in
				for (var i = currentDay + 1; i < 6; i++){
					var currScale = roundBins[i];
					var currID = "#p" + currScale(tempTeam[0]["placement"]) + i;
					var rdID = "rd" + i;
					var saturationIndex = tempTeam[0][rdID];
					bracketSvg.selectAll(currID)
						.style("fill", d3.hsl(hueIndex, saturationIndex, 0.5));
					// Slice labels
					var currSlice = {x: currScale(tempTeam[0]["placement"]), y:i};
					var currCentroid = getCentroid(currSlice);
					bracketSvg.append("text")
						.attr("id", "sliceLabel")
						.attr("x", currCentroid[0])
						.attr("y", currCentroid[1])
						.attr("text-anchor", "middle")
						.attr("font-size", "8")
						.text(saturationIndex.toFixed(2));
				}
				// Center label
				bracketSvg.append("circle")
					.attr("id", "centerLabel")
					.attr("cx", 0)
					.attr("cy", 0)
					.attr("r", padding)
					.attr("fill", "white");
				bracketSvg.append("text")
					.attr("id", "centerLabel")
					.attr("x", 0)
					.attr("y", 0)
					.attr("font-size", "8pt")
					.attr("text-anchor", "middle")
					.text(teamName);
				bracketSvg.append("text")
					.attr("id", "centerLabel")
					.attr("x", 0)
					.attr("y", 10)
					.attr("font-size", "8pt")
					.attr("text-anchor", "middle")	
					.text(tempTeam[0]["rd6"].toFixed(2));
			}
		}
		var myScales;
		var width = 900,
			    height = width,
			    radius = width,
			    padding = 50,
			    duration = 1000;
	    var bracketSvg = d3.select("#bracketCircle")
		    				.append("g")
		    				.attr("transform", "translate(" + width/2 + "," + width/2 + ")");
		var lastID = "";
		// Main function: creates the circle using the slices and then updates with interactivity
		function createCircle(data){
			var slices = createSlices();
		    pi = slices;
			var paths = bracketSvg.selectAll("path");
			paths.data(slices).enter()
				.append("path")
				.attr("d", getArc())
				.attr("id", function(d) {
					return "p" + d.x + d.y;
				})
				.attr("fill", "white")
				.attr("stroke", "#90908B")
				.on("mousemove", mouseMove);
			// Initializes the center circle
			bracketSvg.append("circle")
				.attr("cx", 0)
				.attr("cy", 0)
				.attr("r", padding)
				.attr("fill", "white");
			// Initializes the logos on the outside
			for (var i = 1; i <= 64; i++){
				var currID = "#p" + i + 0;
				var teamName = reverseData.get(i)[0]["teamName"];
				var currSlice = {x: i, y:0};
				var currCentroid = getCentroid(currSlice);
				bracketSvg.append('image')
					.attr("class", "logoLabel0")
					.attr("id", "logoLabel" + teamName + "0")
					.attr("xlink:href", "Data/logos/" + teamName + ".png")
					.attr("x", currCentroid[0] - 8)
					.attr("y", currCentroid[1] - 5)
					.attr("width", "15")
					.attr("height", "15");
			}
		}
		function updateProbabilities(){

		}
		var lastDay = 0;
		var currentDay = 0;
		function updateRound(day){
			//console.log("----- NEW DAY -----");
			if (lastDay != "" && lastDay > day){
				bracketSvg.selectAll(".logoLabel" + lastDay).remove();
			}
			if (day != 0){
				var roundWinners = winningTeams[day];
				roundWinners.forEach(function (winner){
					var currSlice = {x: Number(winner.position), y: Number(day)};
					var teamName = winner.name;
					if (Number(day) == 5 && teamName == "Gonzaga"){
						currSlice = {x: 1, y: 5};
					}
					var currCentroid = getCentroid(currSlice);
					if (teamName != "Rhode Island"){
						bracketSvg.append('image')
							.attr("class", "logoLabel" + day)
							.attr("id", "logoLabel" + teamName + day)
							.attr("xlink:href", "Data/logos/" + teamName + ".png")
							.attr("x", currCentroid[0] - 8)
							.attr("y", currCentroid[1] - 5)
							.attr("width", "15")
							.attr("height", "15");
					}
				});
			}
			lastDay = day;
		}
		/*
		function updateRound(day){
			//console.log("----- NEW DAY -----");
			var game = 1;
			var interval = Math.pow(2, day);
			var winner;
			var roundBins = getScales();
			var currScale = roundBins[day - 1];
			if (lastDay != "" && lastDay > day){
				bracketSvg.selectAll(".logoLabel" + lastDay).remove();
			}
			lastDay = day;
			while (game < 64){
				//console.log("Overall " + game);
				for (var i = 0; i < interval; i++){
					var rdID = "rdWin" + day; 
					var tempWinner = reverseScoreData.get(game + i)[0][rdID];
					if (tempWinner == 1){
						//console.log("Game " + game + i);
						var teamName = reverseScoreData.get(game + i)[0]["teamName"];
						var currSlice = {x: currScale(game + i), y: day};
						if (Number(day) == 5 && teamName == "Gonzaga"){
							currSlice = {x: 1, y: 5};
						}
						var currCentroid = getCentroid(currSlice);
						if (teamName != "Rhode Island"){
							bracketSvg.append('image')
								.attr("class", "logoLabel" + day)
								.attr("id", "logoLabel" + teamName + day)
								.attr("xlink:href", "Data/logos/" + teamName + ".png")
								.attr("x", currCentroid[0] - 8)
								.attr("y", currCentroid[1] - 5)
								.attr("width", "15")
								.attr("height", "15");
						}
					}
					else {
						// Fill in here for graying out losers
						if (teamName != "Rhode Island"){
							//console.log("here");
							//bracketSvg.selectAll("#logoLabel" + teamName + lastDay).remove();
						}
					}
				}
				game += interval;
			}
		}
		// On mouse move
		function mouseMove(d){
			//console.log(d);
			var roundBins = getScales();
			var hueScale = d3.scaleLinear().domain([1,64]).range([0, 360]);
			if (lastID != ""){
				reset(bracketSvg, roundBins, lastID);
			}
			var hueIndex = hueScale(d.x);
			var saturationIndex = reverseData.get(d.x)[0].rd0;
			if (d.y == currentDay){
				lastID = {x: d.x, y: d.y};
				// Highlights outer layer
				bracketSvg.selectAll("#p" + d.x + d.y)
							.style("fill", "#C8C8C8");
				var teamName = winningTeams[d.y][d.x -1].name;
				// Goes through path and fills in
				for (var i = currentDay + 1; i < 6; i++){
					var currScale = roundBins[i - 1];
					var currID = "#p" + currScale(d.x) + i;
					var rdID = "rd" + i;
					console.log(teamPredict.get(teamName));
					saturationIndex = reverseData.get(d.x)[0][rdID];
					bracketSvg.selectAll(currID)
						.style("fill", d3.hsl(hueIndex, saturationIndex, 0.5));
					// Slice labels
					var currSlice = {x: d.x, y:i};
					var currCentroid = getCentroid(currSlice);
					bracketSvg.append("text")
						.attr("id", "sliceLabel")
						.attr("x", currCentroid[0])
						.attr("y", currCentroid[1])
						.attr("text-anchor", "middle")
						.attr("font-size", "8")
						.text(saturationIndex.toFixed(2));

				}
				// Center label
				bracketSvg.append("circle")
					.attr("id", "centerLabel")
					.attr("cx", 0)
					.attr("cy", 0)
					.attr("r", padding)
					.attr("fill", "white");
				bracketSvg.append("text")
					.attr("id", "centerLabel")
					.attr("x", 0)
					.attr("y", 0)
					.attr("font-size", "8pt")
					.attr("text-anchor", "middle")
					.text(reverseData.get(d.x)[0]["teamName"]);
				bracketSvg.append("text")
					.attr("id", "centerLabel")
					.attr("x", 0)
					.attr("y", 10)
					.attr("font-size", "8pt")
					.attr("text-anchor", "middle")	
					.text(reverseData.get(d.x)[0]["rd6"].toFixed(2));
			}
		}
		*/
		// Changes round
		d3.select("#daySlider").on("input", function(){
			updateRound(Number(daySlider.value)); 
			currentDay = Number(daySlider.value);
		});
	</script>
</html>
